# Twilio Backend

TypeScript Fastify backend for WhatsApp automation that blends Twilio messaging, OpenAI responses, Chroma knowledge retrieval, and Google Drive conversation exports.

## Technology Stack

- Node.js 20 runtime with strict TypeScript
- Fastify with form parsing and structured logging
- Twilio WhatsApp messaging client with fakes for tests
- OpenAI GPT + embedding APIs backed by Chroma vector store
- Google Drive service account for CSV transcript storage
- Vitest, ESLint, Prettier, Husky, and lint-staged for DX

## Key Features

- Automated WhatsApp replies generated by OpenAI with system prompts and retrieval-augmented context from Chroma
- Structured routing pipeline: routes â†’ handlers â†’ services â†’ external clients
- Environment validation with Zod and strict runtime defaults for tests
- Offline-friendly fakes for OpenAI, Twilio, and Chroma to support deterministic testing
- Conversation transcripts exported as CSV files to Google Drive

## Directory Structure

```
twilio-be/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.ts                 # Builds Fastify instance and wiring
â”‚   â”œâ”€â”€ index.ts               # Entry point (production)
â”‚   â”œâ”€â”€ server.ts              # Server bootstrap with dependency graph
â”‚   â”œâ”€â”€ env.ts                 # Zod-based environment validation
â”‚   â”œâ”€â”€ logger.ts              # Pino logger configuration
â”‚   â”œâ”€â”€ routes/                # Fastify route definitions
â”‚   â”‚   â”œâ”€â”€ index.ts           # Route registration
â”‚   â”‚   â””â”€â”€ messages.ts        # Message routes
â”‚   â”œâ”€â”€ handlers/              # HTTP handlers with validation
â”‚   â”‚   â””â”€â”€ messages.ts        # Message handlers
â”‚   â”œâ”€â”€ services/              # Business logic
â”‚   â”‚   â”œâ”€â”€ ai/                # AI-related services
â”‚   â”‚   â”‚   â”œâ”€â”€ conversationHistory.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ knowledgeBase.ts
â”‚   â”‚   â”‚   â””â”€â”€ openai.ts
â”‚   â”‚   â”œâ”€â”€ export/            # Export services
â”‚   â”‚   â”‚   â””â”€â”€ conversationCsv.ts
â”‚   â”‚   â””â”€â”€ messaging/         # Messaging services
â”‚   â”‚       â””â”€â”€ twilio.ts
â”‚   â”œâ”€â”€ clients/               # External SDK wrappers and fakes
â”‚   â”‚   â”œâ”€â”€ chromadb.ts / chromadb.fake.ts
â”‚   â”‚   â”œâ”€â”€ googleDrive.ts
â”‚   â”‚   â”œâ”€â”€ openai.ts / openai.fake.ts
â”‚   â”‚   â””â”€â”€ twilio.ts / twilio.fake.ts
â”‚   â”œâ”€â”€ prompts/               # System prompt configuration
â”‚   â”‚   â””â”€â”€ system.ts
â”‚   â”œâ”€â”€ types/                 # Shared types and schemas
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ utils/                 # Utility functions
â”‚       â””â”€â”€ contentNormalizer.ts
â”œâ”€â”€ tests/                     # Vitest unit, integration, and e2e suites
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”œâ”€â”€ env.example                # Sample configuration
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## Setup

### Prerequisites

- Node.js 20+
- Twilio account with WhatsApp sender or Messaging Service
- OpenAI API credentials with access to GPT and embeddings
- Chroma tenant credentials (cloud or self-hosted)
- Google Cloud service account with Drive API enabled

### Installation

1. Clone and install dependencies
   ```bash
   git clone <repository-url>
   cd twilio-be
   npm install
   ```
2. Copy the environment template and populate secrets
   ```bash
   cp env.example .env
   ```
3. Fill `.env` with the values described below.

## Environment Variables

| Variable | Description | Required | Example |
| --- | --- | --- | --- |
| `NODE_ENV` | Runtime environment (`development`/`test`/`production`) | No | `development` |
| `PORT` | HTTP port | No (defaults 3000) | `3000` |
| `TWILIO_ACCOUNT_SID` | Twilio Account SID (must start with `AC`) | Yes | `ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` |
| `TWILIO_AUTH_TOKEN` | Twilio Auth Token | Yes | `your_auth_token` |
| `TWILIO_PHONE_NUMBER` | WhatsApp-enabled phone number in E.164 (`whatsapp:+15551234567`) | Conditionally* | `whatsapp:+15551234567` |
| `TWILIO_MESSAGING_SERVICE_SID` | Messaging Service SID (`MG`/`US` prefix) | Conditionally* | `MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` |
| `OPENAI_API_KEY` | OpenAI API key | Yes | `sk-...` |
| `OPENAI_MODEL` | Chat completion model name | Yes | `gpt-4o-mini` |
| `OPENAI_EMBEDDING_MODEL` | Embedding model for Chroma documents | Yes | `text-embedding-3-small` |
| `OPENAI_MAX_CONTEXT_TOKENS` | Token budget for conversation context | No (defaults to `700`) | `700` |
| `CHROMA_API_KEY` | Chroma API key | Yes | `ck-...` |
| `CHROMA_TENANT` | Chroma tenant identifier | Yes | `my-tenant` |
| `CHROMA_DATABASE` | Chroma database name | Yes | `knowledge-base` |
| `CHROMA_COLLECTION` | Chroma collection name | Yes | `whatsapp-support` |
| `GOOGLE_SERVICE_ACCOUNT_EMAIL` | Service account email with Drive access | Yes | `service-account@example.com` |
| `GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY` | Service account private key | Yes | `-----BEGIN PRIVATE KEY-----\n...` |
| `GOOGLE_DRIVE_FOLDER_ID` | Drive folder to store transcripts | Yes | `1AbCDefGhIJklMNop` |

\*Either `TWILIO_PHONE_NUMBER` or `TWILIO_MESSAGING_SERVICE_SID` must be present (production). Tests inject defaults automatically.

## API Endpoints

### `GET /`

Health probe that returns the service status.

Response
```json
{
  "ok": true
}
```

### `POST /whatsapp`

Accepts incoming WhatsApp messages from Twilio, generates an AI response, and sends it back through Twilio.

**Standard Message Flow:**
- Receives a WhatsApp message
- Generates an AI response using OpenAI with Chroma knowledge retrieval
- Sends the response back via Twilio
- Maintains conversation history for context

**Export Feature:**
- Send the message `"export"` (case-insensitive) to trigger CSV export
- Exports conversation history to Google Drive as a CSV file
- Returns a confirmation message to the user

Request
```json
{
  "From": "whatsapp:+15550001111",
  "Body": "Do you offer weekend workshops?"
}
```

Success Response (Standard Message)
```json
{
  "success": true,
  "messageSid": "SMXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
}
```

Success Response (Export Triggered)
```json
{
  "success": true
}
```

Validation Error (400)
```json
{
  "error": "Invalid request body",
  "details": {
    "Body": ["Body field is required"]
  }
}
```

Error Response (500)
```json
{
  "error": "Failed to send message",
  "details": "Error details here"
}
```

## Development Commands

```bash
npm run dev     # Start Fastify with tsx watch
npm run build   # Type-check and emit to dist/
npm run start   # Run compiled server from dist/
npm run lint    # ESLint on src/
npm run format  # Prettier format src/
npm run clean   # Remove dist/ artifacts
```

## Testing

- `npm test` â€“ run all Vitest suites (unit, integration, e2e)
- Set `USE_FAKE_CLIENTS=true` or rely on NODE_ENV=test to avoid hitting live providers
- Tests cover services, external clients (with fakes), and HTTP flows end-to-end

## Deployment

- CI/CD via GitHub Actions workflow `.github/workflows/deploy.yml`
- Railway deploys on push to `main`; ensure `RAILWAY_TOKEN` is configured as a GitHub secret
- Production build:
  ```bash
  npm run build
  npm run start
  ```

## Project Status

ðŸš€ **Active development**

- âœ… Fastify server with modular routes/handlers/services
- âœ… OpenAI + Chroma retrieval-assisted WhatsApp responses
- âœ… Deterministic fakes for integration and e2e tests
- âœ… Google Drive CSV export for conversation transcripts
- âœ… Zod runtime environment validation
- ðŸ”„ Continuing work on prompt iteration, analytics, and observability

